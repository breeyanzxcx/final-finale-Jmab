<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>About</title>
  <link rel="stylesheet" href="../CSS/about.css">
  <link rel="stylesheet" href="../CSS/message.css">
  <link rel="icon" type="image/x-icon" href="../imahe/jmab no bg.png">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>
  <nav class="navbar">
    <div class="logo-container">
      <img src="../imahe/j-mab.png" alt="J-MAB Logo">
      <span>J-MAB</span>
    </div> 

    <div class="nav-links">
      <a id="hehe" href="./home.html">HOME</a>
      <a id="hehe" href="./productPage.html?category=tires">PRODUCTS</a>
      <a id="hehe" href="./about.html" class="active">ABOUT</a>
    </div>

    <div class="action-icons">
      <a href="../HTML/userCart.html">
        <img src="../imahe/cart.png" alt="Cart Icon">
      </a>

      <a href="#" onclick="toggleMessenger(event)">
        <img src="../imahe/message.png" alt="Message Icon">
      </a>

      <div class="notification-wrapper">
        <a href="#" class="notification-icon" id="notificationIcon">
          <img src="../imahe/notifications.png" alt="Notification Icon">
          <span class="notification-badge" id="notificationBadge">0</span>
        </a>
        <div class="notification-dropdown" id="notificationDropdown">
          <h4>Notifications</h4>
          <ul id="notificationList">
            <li class="notification-empty">Loading notifications...</li>
          </ul>
        </div>
      </div>

      <div class="profile-button" onclick="toggleDropdown()">
        <img src="../imahe/prof.png" alt="Profile Icon">
      </div>
      <div class="profile-dropdown" id="profileDropdown">
        <a href="../HTML/profile.html">My Profile</a>
        <a href="#" id="logout">Logout</a>
      </div>
    </div>
  </nav>

  <!-- Messenger Popup -->
  <div class="messenger-wrapper">
    <div class="messenger-box" id="messengerBox">
      <div class="messenger-header">
        <select id="contactSelect">
          <option value="support">Customer Support</option>
          <option value="john">John Doe</option>
          <option value="jane">Jane Smith</option>
          <option value="mike">Mike Johnson</option>
        </select>
        <div class="messenger-actions">
          <span onclick="toggleMessenger(event)">Ã—</span>
        </div>
      </div>
      <div class="messenger-body" id="messengerBody">
        <ul class="message-list" id="messageList">
          <!-- Messages will be populated by JS -->
        </ul>
      </div>
      <div class="message-input">
        <input type="text" id="messageInput" placeholder="Type a message...">
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>

  <header class="about-header">
    <div class="header-content">
      <h1>Driven by <span class="highlight">Passion</span>, Committed to Quality</h1>
      <p class="tagline">Your trusted partner in car care and performance.</p>
    </div>
  </header>

  <section class="about-container">
    <div class="about-section">
      <h2>J-Mab</h2>
      <p>At J-MAB, we're passionate about helping you get the most out of your vehicle. 
        We offer a wide range of high-quality car supplies, from performance parts to everyday essentials,  
        all designed to keep your car running smoothly and efficiently. Whether you're upgrading your ride 
        or simply maintaining it, we make it easy to find the products you need. Your journey matters to us, 
        and we're here to support you every mile of the way with reliable, top-notch car care solutions.</p>
    </div>

    <div class="about-section">
      <h2>What We Offer</h2>
      <p>From high-performance tires to maintenance supplies, we bring you the best in automotive care:</p>
      <div class="products-grid">
        <div class="product-category">
          <img src="../Products/Tire(3).png" alt="Tires">
          <h3>Premium Tires</h3>
        </div>

        <div class="product-category">
          <img src="../Products/Lubricant(2).png" alt="Parts">
          <h3>Performance Parts</h3>
        </div>

        <div class="product-category">
          <img src="../Products/Oil(2).png" alt="Oil">
          <h3>Maintenance Supplies</h3>
        </div>
      </div>
    </div>

    <div class="about-section">
      <h2>Why Choose J-MAB?</h2>
      <div class="values-container">
        <div class="value-item">
          <h3>Top-Quality Products</h3>
          <p>Every item is handpicked for durability and reliability.</p>
        </div>

        <div class="value-item">
          <h3>Expert Advice</h3>
          <p>Our team of professionals is ready to assist you with expert recommendations.</p>
        </div>

        <div class="value-item">
          <h3>Customer-Centric Service</h3>
          <p>We prioritize your satisfaction with fast service and a smooth shopping experience.</p>
        </div>
      </div>
    </div>

    <div class="about-section">
      <h2>Visit Us</h2>
      <p>Drop by and let us help you find the best car solutions.</p>
      <div class="contact-details">
        <div class="contact-item">
          <img src="../imahe/location(blue).png" alt="Location">
          <p>
            <a href="https://www.google.com/maps/place/87+Tebeng+Rd,+Dagupan,+Pangasinan/@16.0356193,120.3567036,696m/data=!3m2!1e3!4b1!4m5!3m4!1s0x339142a6bd9e0ac9:0x917be9d95001da77!8m2!3d16.0356142!4d120.3592785?entry=ttu" style="text-decoration: none" target="_blank">
              87 Tebeng Road Dagupan City, Pangasinan</a>
          </p>
        </div>

        <div class="contact-item">
          <img src="../imahe/call_icon.png" alt="Phone">
          <p>0977 769 3620 |  0946 298 6767</p>
        </div>

        <div class="contact-item">
          <img src="../imahe/box.png" alt="Email">
          <p>
            <a href="https://mail.google.com/mail/?view=cm&fs=1&to=jmab.business@gmail.com" style="text-decoration: none;" target="_blank">
              jmab.business@gmail.com</a>
          </p>
        </div>

        <div class="contact-item">
          <img src="../imahe/fb.png" alt="Facebook">
          <p>
            <a href="https://www.facebook.com/jmab.trd" target="_blank" style="text-decoration: none;">
              J-MAB Vehicle Tires and Batteries Trading 
            </a>
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- Custom Logout Pop-Up -->
  <div id="logoutPopup" class="popup">
    <div class="popup-content">
      <h3>Logout Confirmation</h3>
      <p>Are you sure you want to log out?</p>
      <div class="popup-buttons">
        <button id="confirmLogout" class="popup-btn confirm">Yes</button>
        <button id="cancelLogout" class="popup-btn cancel">No</button>
      </div>
    </div>
  </div>

  <script src="../JS/logout.js"></script>
  <script src="../JS/message.js"></script>
  <script src="../JS/websocketManager.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const userId = localStorage.getItem('userId');
        const authToken = localStorage.getItem('authToken');
    
        if (!userId || !authToken) {
            console.error('User not authenticated. Please log in.');
            return;
        }
    
        // WebSocket Initialization (if applicable)
        let notificationWS;
        if (typeof WebSocketManager !== 'undefined') { // Check if websocketManager.js is loaded
            notificationWS = new WebSocketManager(WS_NOTIFICATION_URL, 'notification');
            notificationWS.connect(userId, authToken, function(data) {
                if (data.type === 'notification') {
                    handleNotificationReceived(data);
                }
            });
        }
    
        // Notification dropdown toggle
        const notificationIcon = document.getElementById('notificationIcon');
        const notificationDropdown = document.getElementById('notificationDropdown');
        notificationIcon.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const isVisible = notificationDropdown.style.display === 'block';
            notificationDropdown.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                fetchNotifications(); // Fetch notifications when opening
            }
        });
    
        // Close dropdown when clicking outside
        window.addEventListener('click', function(e) {
            const notificationWrapper = document.querySelector('.notification-wrapper');
            if (!notificationWrapper.contains(e.target)) {
                notificationDropdown.style.display = 'none';
            }
    
            // Handle profile dropdown
            const profileButton = document.querySelector('.profile-button');
            const profileDropdown = document.getElementById('profileDropdown');
            if (!profileButton.contains(e.target) && !profileDropdown.contains(e.target)) {
                profileDropdown.style.display = 'none';
            }
    
            // Handle messenger box
            const messengerBox = document.getElementById('messengerBox');
            const messageIcon = document.querySelector('.action-icons a[href="#"] img[src="../imahe/message.png"]');
            if (messengerBox.style.display === 'block' && 
                !messengerBox.contains(e.target) && 
                !messageIcon.contains(e.target)) {
                messengerBox.style.display = 'none';
            }
        });
    
        // Profile dropdown toggle
        function toggleDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.style.display = dropdown.style.display === 'flex' ? 'none' : 'flex';
        }
    
        // Fetch notifications from API
        async function fetchNotifications() {
            try {
                const response = await fetch(`http://localhost/jmab/final-jmab/api/notifications/user/${userId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    }
                });
    
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
    
                const data = await response.json();
                const notificationList = document.getElementById('notificationList');
                const notificationBadge = document.getElementById('notificationBadge');
                notificationList.innerHTML = '';
    
                if (data.success && data.notifications.length > 0) {
                    data.notifications.forEach(notification => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <div class="${notification.is_read ? '' : 'unread-notification'}">
                                <strong>${notification.title || 'Notification'}</strong>
                                <p>${notification.message}</p>
                                <small>${formatTimestamp(notification.created_at)}</small>
                            </div>
                        `;
                        if (!notification.is_read) {
                            li.style.cursor = 'pointer';
                            li.addEventListener('click', async () => {
                                await markAsRead(notification.id);
                                notification.is_read = true;
                                renderNotifications(data.notifications);
                            });
                        }
                        notificationList.appendChild(li);
                    });
    
                    const unreadCount = data.notifications.filter(n => !n.is_read).length;
                    notificationBadge.textContent = unreadCount;
                    notificationBadge.style.display = unreadCount > 0 ? 'inline-block' : 'none';
                } else {
                    notificationList.innerHTML = '<li class="notification-empty">No new notifications</li>';
                    notificationBadge.textContent = '0';
                    notificationBadge.style.display = 'none';
                }
            } catch (error) {
                console.error('Error fetching notifications:', error);
                document.getElementById('notificationList').innerHTML = '<li class="notification-empty">Error loading notifications</li>';
            }
        }
    
        // Handle incoming WebSocket notifications (if applicable)
        function handleNotificationReceived(data) {
            fetchNotifications(); // Refresh the list when a new notification arrives
        }
    
        // Mark notification as read (API call)
        async function markAsRead(notificationId) {
            try {
                const response = await fetch(`http://localhost/jmab/final-jmab/api/notifications/mark-read/${notificationId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    }
                });
    
                if (!response.ok) {
                    throw new Error('Failed to mark notification as read');
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }
    
        // Format timestamp
        function formatTimestamp(timestamp) {
            return new Date(timestamp).toLocaleString([], {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    
        // Expose toggleDropdown globally if needed by onclick attribute
        window.toggleDropdown = toggleDropdown;
    
        // Initial fetch
        fetchNotifications();
    
        // Reconnect WebSocket on visibility change (if applicable)
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible' && notificationWS) {
                notificationWS.reconnectIfNeeded(userId, authToken, handleNotificationReceived);
                fetchNotifications();
            }
        });
    
        // Cleanup WebSocket on unload (if applicable)
        window.addEventListener('beforeunload', () => {
            if (notificationWS) notificationWS.close();
        });
    });
    </script>
</body>
</html>